<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TMS â€“ Participant Checkâ€‘In (Live)</title>
<style>
  :root{--bg:#0b1222;--card:#0f172a;--mut:#94a3b8;--line:#1f2937;--text:#e5e7eb;--acc:#22d3ee}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b1222,#0a1327 55%,#0b1222);font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  h1{margin:0 0 8px 0;font-size:20px}
  .card{background:rgba(17,24,39,.7);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:12px}
  .mut{color:var(--mut)}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
  .warn{background:rgba(234,179,8,.18);border-color:rgba(234,179,8,.35)}
  input,select,button{border-radius:10px;border:1px solid var(--line);background:#0b1222;color:var(--text);padding:10px}
  button.primary{background:linear-gradient(180deg,#22d3ee,#0ea5b7);border-color:#0ea5b7;color:#001018;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .scroller{max-height:260px;overflow:auto;border:1px dashed #1f2937;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:9px;border-bottom:1px solid var(--line);text-align:left}
  th{color:#a3a3a3;background:rgba(31,41,55,.45)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="sessTitle">Session</h1>
    <div class="row"><div id="sessMeta" class="mut">â€”</div><span id="sessStatus" class="pill">â€”</span></div>
  </div>

  <!-- Participant check-in -->
  <div class="card">
    <div class="row" style="justify-content:space-between"><strong>1) Find your name</strong><span class="mut">IC shown without dashes</span></div>
    <select id="nameSelect" onchange="onPick()" style="width:100%;margin:8px 0"></select>
    <div id="picked" class="mut">â€”</div>
    <div class="row" style="margin-top:10px">
      <button id="btnPresent" class="primary" onclick="markPresent()">Mark Present</button>
    </div>
    <div id="msg" class="mut" style="margin-top:8px"></div>
  </div>

  <!-- Walk-in (admin gated) -->
  <div class="card">
    <div class="row" style="justify-content:space-between"><strong>2) Walkâ€‘in (Admin only)</strong><span class="mut">Password protects against abuse</span></div>
    <div class="row"><label>Password</label><input id="pw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" oninput="toggleWalkin()"></div>
    <fieldset id="walkinFS" disabled style="border:none;padding:0;margin:8px 0">
      <div class="row"><label>Active Session</label><select id="w_session"></select></div>
      <div class="row"><label>Name</label><input id="w_name" placeholder="Full name"></div>
      <div class="row"><label>IC (numbers only)</label><input id="w_ic" oninput="this.value=this.value.replace(/\D/g,'')" placeholder="e.g., 900101141111"></div>
      <button class="primary" onclick="walkin()">Add Walkâ€‘in</button>
    </fieldset>
  </div>

  <!-- Admin tools (marks + close) -->
  <div class="card">
    <div class="row" style="justify-content:space-between"><strong>3) Admin Tools</strong><button onclick="openAdmin()">Open</button></div>
    <div id="adminPanel" style="display:none;margin-top:10px">
      <div class="mut">Session Admin â€” <span id="adminSessCode">â€”</span></div>
      <div class="scroller" style="margin-top:6px"><table id="tblMarks"></table></div>
      <div class="row" style="margin-top:10px">
        <button class="primary" onclick="closeSession()">Deactivate / Close Session</button>
        <button onclick="hideAdmin()">Hide</button>
      </div>
      <div id="adminMsg" class="mut" style="margin-top:6px"></div>
    </div>
  </div>

  <div id="done" class="card" style="display:none">
    <strong>Checked in ðŸŽ‰</strong>
    <div id="doneMsg" class="mut" style="margin-top:6px"></div>
  </div>

  <div class="mut" style="margin-top:10px">Connected version. Attendance writes to Google Sheets via Apps Script.</div>
</div>

<script>
// ===== CONFIG =====
const ADMIN_PASSWORD = 'admin123';
let WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbydUYznQqrCfIyNeCHO4Uiit17_RIEKcNig5CWg3cV-1bcgzSZyLRNod66Mk0BBbXXuZQ/exec'; // hard-wired to your API

// ===== STATE =====
let currentSession = null; // class object from backend
let selectedId = null;     // participant id

// ===== HELPERS =====
const $ = s=>document.querySelector(s);
function qp(k){ const u=new URL(location.href); return u.searchParams.get(k); }
function cleanIC(x){ return String(x||'').replace(/\D/g,''); }
function ok(resp){ if(!resp.ok) throw new Error('Network error'); return resp.json(); }
function apiGet(q){ return fetch(WEB_APP_URL+'?'+q).then(ok); }
function apiPost(action, payload){ return fetch(WEB_APP_URL+'?action='+action,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(ok); }

// ===== UI RENDERS =====
function renderSessionHeader(){
  $('#sessTitle').textContent = `${currentSession.prog_code || currentSession.prog || ''} â€¢ ${currentSession.code}`;
  $('#sessMeta').textContent = `${currentSession.start} â†’ ${currentSession.end} â€¢ ${(currentSession.trainer1||'')}${currentSession.trainer2? ' + '+currentSession.trainer2:''}`;
  const active = String(currentSession.active).toLowerCase()!== 'false' && String(currentSession.active)!=='0' && String(currentSession.active).toLowerCase()!=='no';
  const status = $('#sessStatus');
  status.textContent = active? 'Active' : 'Closed';
  status.className = 'pill ' + (active? 'ok' : 'warn');
  const btn = $('#btnPresent'); if(btn) btn.disabled = !active;
  $('#adminSessCode').textContent = currentSession.code;
}
function renderNameSelect(list){
  const sel = $('#nameSelect');
  sel.innerHTML = `<option value="">â€” Choose name â€”</option>` +
    list.map(p=>`<option value="${p.id}">${p.name} â€¢ ${cleanIC(p.ic)}</option>`).join('');
}
function onPick(){
  selectedId = $('#nameSelect').value || null;
  if(!selectedId){ $('#picked').textContent='â€”'; return; }
  const p = window.PEOPLE.find(x=>String(x.id)===String(selectedId));
  $('#picked').textContent = `You: ${p.name} (${cleanIC(p.ic)}). Assigned class: ${currentSession.code} â€¢ ${currentSession.start} â†’ ${currentSession.end}`;
}

// ===== WALK-IN (ADMIN) =====
function toggleWalkin(){ const ok = ($('#pw').value||'') === ADMIN_PASSWORD; $('#walkinFS').disabled = !ok; }
function resetWalkin(){ ['w_name','w_ic'].forEach(id=>$('#'+id).value=''); }
async function walkin(){
  if($('#walkinFS').disabled){ alert('Enter admin password to enable walkâ€‘in.'); return; }
  const s = $('#w_session').value; if(!s){ alert('Pick a session'); return; }
  // verify selected session is active
  const isActive = (window.ACTIVE_CLASSES||[]).some(c=> String(c.id)===String(s));
  if(!isActive){ alert('Walkâ€‘in allowed only into ACTIVE class.'); return; }
  const payload = { action:'save_participant', session:s, name: $('#w_name').value, ic: cleanIC($('#w_ic').value), pos:'Technician' };
  const r = await apiPost('save_participant', payload).catch(e=>({ok:false,error:e.message}));
  if(!r.ok){ alert('Error: '+(r.error||'failed')); return; }
  $('#pw').value=''; toggleWalkin(); resetWalkin();
  $('#msg').textContent = 'Walkâ€‘in added. Now tap Mark Present.';
  await loadParticipants();
}

// ===== ATTENDANCE =====
async function markPresent(){
  const active = String(currentSession.active).toLowerCase()!== 'false' && String(currentSession.active)!=='0' && String(currentSession.active).toLowerCase()!=='no';
  if(!active){ $('#msg').textContent = 'This class is closed. Checkâ€‘in unavailable.'; return; }
  if(!selectedId){ $('#msg').textContent = 'Please select your name first.'; return; }
  const p = window.PEOPLE.find(x=>String(x.id)===String(selectedId));
  const r = await apiPost('mark_attendance', { action:'mark_attendance', session: currentSession.id, ic: cleanIC(p.ic) }).catch(e=>({ok:false,error:e.message}));
  if(!r.ok){ $('#msg').textContent = 'Error: '+(r.error||'failed'); return; }
  $('#done').style.display = 'block';
  $('#doneMsg').textContent = `${p.name} marked Present for ${currentSession.code}.`;
}

// ===== ADMIN PANEL =====
let adminUnlocked=false;
function openAdmin(){ if(adminUnlocked) return showAdmin(); const pw=prompt('Enter admin password'); if(pw===ADMIN_PASSWORD){ adminUnlocked=true; showAdmin(); } else alert('Wrong password.'); }
function showAdmin(){ $('#adminPanel').style.display='block'; renderMarks(); }
function hideAdmin(){ $('#adminPanel').style.display='none'; }
async function renderMarks(){
  if(!adminUnlocked) return;
  const r = await apiGet('action=list_participants&session='+encodeURIComponent(currentSession.id));
  if(!r.ok){ $('#adminMsg').textContent='Error loading participants'; return; }
  const rows = (r||[]).map?pRowsFromOld(r):r.data.map(p=>
    `<tr><td>${p.Name||p.name}<div class="mut">IC ${cleanIC(p.IC||p.ic)}</div></td><td>${p.Position||p.position||''}</td><td><input type="number" min="0" max="100" value="${p.Mark||p.mark||''}" style="width:90px" oninput="saveMark('${cleanIC(p.IC||p.ic)}', this.value)"/></td></tr>`
  );
  $('#tblMarks').innerHTML = `<thead><tr><th>Name</th><th>Position</th><th>Mark</th></tr></thead><tbody>${rows.join('')}</tbody>`;
}
function pRowsFromOld(r){ // fallback if older doGet format returns array of arrays
  return [];
}
async function saveMark(ic, v){ const r = await apiPost('save_mark', { action:'save_mark', session: currentSession.id, ic: ic, mark: v }).catch(e=>({ok:false,error:e.message})); if(!r.ok){ $('#adminMsg').textContent='Error saving mark'; return; } $('#adminMsg').textContent='Mark saved'; }
async function closeSession(){ const r = await apiPost('close_class', { action:'close_class', session: currentSession.id }).catch(e=>({ok:false,error:e.message})); $('#adminMsg').textContent = r.ok? 'Session closed' : ('Error: '+(r.error||'failed')); await loadSession(); }

// ===== LOAD DATA =====
async function loadActiveClasses(){
  const r = await apiGet('action=list_classes');
  // Support two shapes: raw sheet array vs wrapped {ok,data}
  const arr = (r && r.data)? r.data : (Array.isArray(r)? r : []);
  // Expect header row in index 0 if raw; normalize to objects
  let rows = arr;
  if(Array.isArray(arr) && arr.length && Array.isArray(arr[0])){
    const headers = arr[0]; rows = arr.slice(1).map(a=>{ const o={}; headers.forEach((h,i)=>o[h]=a[i]); return o; });
  }
  const all = rows.map(x=>({
    id: x['Session ID']||x.id,
    prog_code: x['Program Code']||x.prog_code||x.prog,
    code: x['Session Code']||x.code,
    start: x['Start']||x.start,
    end: x['End']||x.end,
    trainer1: x['Trainer 1']||x.trainer1||x.t1,
    trainer2: x['Trainer 2']||x.trainer2||x.t2,
    active: String(x['Active']||x.active||'').toUpperCase().includes('Y') || String(x['Active']||x.active||'').toLowerCase()==='true'
  }));
  window.ACTIVE_CLASSES = all.filter(c=>c.active);
  $('#w_session').innerHTML = window.ACTIVE_CLASSES.map(c=>`<option value="${c.id}">${c.code}</option>`).join('');
  return all;
}

async function loadSession(){
  const all = await loadActiveClasses();
  const sid = qp('session');
  // Fetch all classes again to ensure closed sessions can still render
  const r2 = await apiGet('action=list_classes');
  let rows = (r2 && r2.data)? r2.data : (Array.isArray(r2)? r2 : []);
  if(rows.length && Array.isArray(rows[0])){ const headers=rows[0]; rows=rows.slice(1).map(a=>{ const o={}; headers.forEach((h,i)=>o[h]=a[i]); return o; }); }
  currentSession = rows.map(x=>({
    id: x['Session ID']||x.id,
    prog_code: x['Program Code']||x.prog_code||x.prog,
    code: x['Session Code']||x.code,
    start: x['Start']||x.start,
    end: x['End']||x.end,
    trainer1: x['Trainer 1']||x.trainer1||x.t1,
    trainer2: x['Trainer 2']||x.trainer2||x.t2,
    active: String(x['Active']||x.active||'').toUpperCase().includes('Y') || String(x['Active']||x.active||'').toLowerCase()==='true'
  })).find(c=> String(c.id)===String(sid));
  if(!currentSession){ throw new Error('Session not found'); }
  renderSessionHeader();
}

async function loadParticipants(){
  const r = await apiGet('action=list_participants&session='+encodeURIComponent(currentSession.id));
  let list = (r && r.data)? r.data : (Array.isArray(r)? r : []);
  if(list.length && Array.isArray(list[0])){ const headers=list[0]; list=list.slice(1).map(a=>{ const o={}; headers.forEach((h,i)=>o[h]=a[i]); return o; }); }
  window.PEOPLE = list.map(p=>({ id: p['Participant ID']||p.id||cleanIC(p['IC']||p.ic), name: p['Name']||p.name, ic: cleanIC(p['IC']||p.ic), position: p['Position']||p.position }));
  renderNameSelect(window.PEOPLE);
}

// ===== INIT =====
(async function init(){
  try{
    await loadSession();
    await loadParticipants();
  }catch(e){
    document.getElementById('msg').textContent = 'Setup error: '+e.message+' â€” ensure session=CLS-XXXX in URL.';
  }
})();
</script>
</body>
</html>
