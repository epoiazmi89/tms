<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TMS â€“ Admin (Live)</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--line:#1f2937;--text:#e5e7eb;--acc:#22d3ee}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1222,#0a1327 55%,#0b1222);font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
  .wrap{max-width:1250px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:38px;height:38px;border-radius:12px;background:radial-gradient(circle at 30% 30%,#67e8f9,#22d3ee 40%,#0891b2);box-shadow:0 0 40px rgba(34,211,238,.25)}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .tab{background:#0b1222;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
  .tab.active{border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.2) inset}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{background:rgba(17,24,39,.7);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .kpi{display:flex;align-items:center;gap:12px}
  .kpi-badge{width:34px;height:34px;border-radius:10px;background:rgba(34,211,238,.12);display:grid;place-items:center;border:1px solid rgba(34,211,238,.3)}
  .kpi h3{margin:0;font-size:14px;color:#a5b4fc}
  .kpi .num{font-size:24px;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:#a3a3a3;font-weight:600;background:rgba(31,41,55,.45)}
  tr:hover td{background:rgba(2,6,23,.35)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  input,select,button,textarea{border-radius:10px;border:1px solid var(--line);background:#0b1222;color:var(--text);padding:10px}
  textarea{min-height:92px;width:100%}
  button.primary{background:linear-gradient(180deg,#22d3ee,#0ea5b7);border-color:#0ea5b7;color:#001018;font-weight:700}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
  .warn{background:rgba(234,179,8,.18);border-color:rgba(234,179,8,.35)}
  .bad{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
  .id{font-family:ui-monospace,Menlo,Consolas,monospace;color:#a7f3d0}
  .footer{margin-top:18px;font-size:12px;color:#9ca3af}
  .scroller{max-height:360px;overflow:auto;border:1px dashed #1f2937;border-radius:12px}
  .login-overlay{position:fixed;inset:0;background:rgba(2,6,23,.85);display:grid;place-items:center}
  .login-card{width:min(440px,92vw)}
</style>
</head>
<body>
<div id="login" class="login-overlay">
  <div class="card login-card">
    <h2 style="margin:0 0 6px 0">Admin Signâ€‘in</h2>
    <div class="muted" style="margin-bottom:10px">This page is protected. Enter admin password to continue.</div>
    <input id="pw" type="password" placeholder="Password" />
    <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
      <button onclick="tryLogin()">Enter</button>
    </div>
    <div id="loginMsg" class="muted" style="font-size:12px"></div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Training Management System</h1>
        <div class="muted" style="font-size:12px">Free stack â€¢ Google Sheets + Apps Script â€¢ Live Admin</div>
      </div>
    </div>
    <nav>
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="programs">1) Programs/Modules</button>
      <button class="tab" data-tab="classes">2) Classes/Sessions</button>
      <button class="tab" data-tab="participants">3) Participants</button>
      <button class="tab" data-tab="qr">4â€“7) QR & Attendance</button>
      <button class="tab" data-tab="results">8â€“9) Results & Close</button>
      <button class="tab" data-tab="reports">Reports</button>
    </nav>
  </header>

  <!-- DASHBOARD -->
  <section data-panel="dashboard">
    <div class="grid">
      <div class="card" style="grid-column: span 3"><div class="kpi"><div class="kpi-badge">ðŸ“¦</div><div><h3>Total Programs/Modules</h3><div class="num" id="k_prog">â€”</div></div></div></div>
      <div class="card" style="grid-column: span 3"><div class="kpi"><div class="kpi-badge">ðŸ“…</div><div><h3>Total Sessions</h3><div class="num" id="k_sess">â€”</div></div></div></div>
      <div class="card" style="grid-column: span 3"><div class="kpi"><div class="kpi-badge">ðŸ‘¥</div><div><h3>Invited Participants</h3><div class="num" id="k_inv">â€”</div></div></div></div>
      <div class="card" style="grid-column: span 3"><div class="kpi"><div class="kpi-badge">ðŸŽ“</div><div><h3>Pass / Fail</h3><div class="num"><span id="k_pass">â€”</span> / <span id="k_fail">â€”</span></div></div></div></div>
      <div class="card" style="grid-column: span 12">
        <div class="toolbar"><strong>Filter by Date</strong><input type="date" id="f_from"/><span class="muted">to</span><input type="date" id="f_to"/><button onclick="applyFilter()">Apply</button></div>
        <div class="grid">
          <div class="card" style="grid-column: span 6"><div class="toolbar"><strong>Attendance Rate by Role</strong></div><div class="scroller"><table id="tblAttendByRole"></table></div></div>
          <div class="card" style="grid-column: span 6"><div class="toolbar"><strong>Upcoming Sessions</strong></div><div class="scroller"><table id="tblUpcoming"></table></div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROGRAMS -->
  <section data-panel="programs" hidden>
    <div class="grid">
      <div class="card" style="grid-column: span 5">
        <div class="toolbar"><strong>Register Program / Module</strong></div>
        <label>Program Title <input id="p_title" placeholder="Service Excellence"/></label>
        <label>Subâ€‘Program / Module Title (optional) <input id="p_sub" placeholder="Module 1: Handling Complaints"/></label>
        <label>Programâ€‘Module Code <input id="p_code" placeholder="SE-M01"/></label>
        <label>Module Duration (hours) <input id="p_dur" type="number" placeholder="6"/></label>
        <label>Author <input id="p_author" placeholder="Amalia"/></label>
        <label>Registration Date <input id="p_reg" type="date"/></label>
        <label>Description <textarea id="p_desc" placeholder="Brief about program & module"></textarea></label>
        <div style="margin-top:10px"><button class="primary" onclick="saveProgram()">Save</button></div>
      </div>
      <div class="card" style="grid-column: span 7">
        <div class="toolbar"><strong>Registered Items</strong><input id="p_search" placeholder="Search title/code" oninput="renderPrograms()"/></div>
        <div class="scroller"><table id="tblPrograms"></table></div>
      </div>
    </div>
  </section>

  <!-- CLASSES -->
  <section data-panel="classes" hidden>
    <div class="grid">
      <div class="card" style="grid-column: span 5">
        <div class="toolbar"><strong>Create Class / Session</strong></div>
        <label>Programâ€‘Module <select id="c_prog"></select></label>
        <label>Session Code <input id="c_code" placeholder="SE-M01-2025-11-001"/></label>
        <label>Starts <input id="c_start" type="date"/></label>
        <label>Ends <input id="c_end" type="date"/></label>
        <label>Trainer 1 <input id="c_t1" placeholder="Trainer A"/></label>
        <label>Trainer 2 (optional) <input id="c_t2" placeholder="Trainer B"/></label>
        <div class="muted" style="font-size:12px">Plan vs Actual analysis supported later.</div>
        <div style="margin-top:10px"><button class="primary" onclick="saveClass()">Save Session</button></div>
      </div>
      <div class="card" style="grid-column: span 7">
        <div class="toolbar"><strong>Registered Sessions</strong><input id="c_search" placeholder="Search code/program" oninput="renderClasses()"/></div>
        <div class="scroller"><table id="tblClasses"></table></div>
      </div>
    </div>
  </section>

  <!-- PARTICIPANTS -->
  <section data-panel="participants" hidden>
    <div class="grid">
      <div class="card" style="grid-column: span 5">
        <div class="toolbar"><strong>Add Participant (to a Session)</strong></div>
        <label>Session <select id="pa_session"></select></label>
        <label>Name <input id="pa_name"/></label>
        <label>IC Number <input id="pa_ic"/></label>
        <label>Company Name <input id="pa_company"/></label>
        <label>Company Code <input id="pa_ccode"/></label>
        <label>Position <select id="pa_pos"></select></label>
        <label>Email (optional) <input id="pa_email"/></label>
        <label>Contact (optional) <input id="pa_phone"/></label>
        <div style="margin-top:10px"><button class="primary" onclick="addParticipant()">Add</button></div>
      </div>
      <div class="card" style="grid-column: span 7">
        <div class="toolbar"><strong>Participants (selected session)</strong></div>
        <div class="scroller"><table id="tblParticipants"></table></div>
      </div>
    </div>
  </section>

  <!-- QR -->
  <section data-panel="qr" hidden>
    <div class="grid">
      <div class="card" style="grid-column: span 5">
        <div class="toolbar"><strong>Generate QR for Session</strong></div>
        <label>Session <select id="q_session"></select></label>
        <button class="primary" onclick="generateQr()">Generate QR</button>
        <div id="qr_area" class="muted" style="margin-top:10px">(QR link)</div>
      </div>
      <div class="card" style="grid-column: span 7">
        <div class="toolbar"><strong>Note</strong></div>
        <p class="muted">Attendance happens on the Participant QR page (the one we set up earlier). This Admin page is for creating programs, sessions, adding participants, and downloading results.</p>
      </div>
    </div>
  </section>

  <!-- RESULTS & CLOSE -->
  <section data-panel="results" hidden>
    <div class="grid">
      <div class="card" style="grid-column: span 5">
        <div class="toolbar"><strong>Enter Test Marks</strong></div>
        <label>Session <select id="r_session"></select></label>
        <div class="scroller"><table id="tblResultList"></table></div>
      </div>
      <div class="card" style="grid-column: span 7">
        <div class="toolbar"><strong>Close / Deactivate Class</strong></div>
        <label>Session <select id="r_close_session"></select></label>
        <button class="primary" onclick="closeSession()">Deactivate</button>
        <div class="footer">Once closed, the session becomes readâ€‘only for attendance.</div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section data-panel="reports" hidden>
    <div class="card">
      <div class="toolbar"><strong>Reports</strong></div>
      <div class="grid">
        <div class="card" style="grid-column: span 12" id="archivedCard"></div>
      </div>
    </div>
  </section>

  <div class="footer">Admin UI â€¢ <strong>Live</strong> â€¢ Connected to Google Sheets via Apps Script â€¢ Password protected</div>
</div>

<script>
/***** CONFIG *****/
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbydUYznQqrCfIyNeCHO4Uiit17_RIEKcNig5CWg3cV-1bcgzSZyLRNod66Mk0BBbXXuZQ/exec';
const ADMIN_PASSWORD = 'admin123';
const POSITIONS = ['Service Manager','Service Advisor','Customer Relation Executive','Job Controller','Parts Controller','Technician','BP Manager','ICA','Body Technician','Paint Technician'];

/***** STATE *****/
let programs = [];
let classes = [];
let participantsCache = new Map(); // sessionId -> [participants]
let loggedIn = false;

/***** HELPERS *****/
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function tbl(h, r){ return `<thead><tr>${h.map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>${r.join('')}</tbody>`; }
function ok(resp){ if(!resp.ok) throw new Error('Network'); return resp.json(); }
function apiGet(q){ return fetch(WEB_APP_URL+'?'+q).then(ok); }
function apiPost(action, payload){ return fetch(WEB_APP_URL+'?action='+action,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(ok); }
function cleanIC(x){ return String(x||'').replace(/\D/g,''); }
function idFmt(x){ return `<span class="id">${x}</span>` }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/***** LOGIN *****/
function tryLogin(){ const pw = $('#pw').value||''; if(pw===ADMIN_PASSWORD){ loggedIn=true; $('#login').style.display='none'; $('#app').style.display='block'; initAfterLogin(); } else { $('#loginMsg').textContent='Wrong password.'; } }

/***** LOADERS *****/
async function loadPrograms(){ const r = await apiGet('action=list_programs'); let rows = r.data || r; if(Array.isArray(rows)&&rows.length&&Array.isArray(rows[0])){ const h=rows[0]; rows=rows.slice(1).map(a=>{ const o={}; h.forEach((k,i)=>o[k]=a[i]); return o; }); } programs = rows.filter(x=>x['Code']||x['Program ID']); }
async function loadClasses(){ const r = await apiGet('action=list_classes'); let rows = r.data || r; if(Array.isArray(rows)&&rows.length&&Array.isArray(rows[0])){ const h=rows[0]; rows=rows.slice(1).map(a=>{ const o={}; h.forEach((k,i)=>o[k]=a[i]); return o; }); } classes = rows.map(x=>({ id:x['Session ID']||x.id, prog:x['Program Code']||x.prog, code:x['Session Code']||x.code, start:x['Start']||x.start, end:x['End']||x.end, t1:x['Trainer 1']||x.t1, t2:x['Trainer 2']||x.t2, active:/^(yes|true|1)$/i.test(String(x['Active']||x.active||'')) })).filter(x=>x.id); }
async function loadParticipants(sessionId){ const r = await apiGet('action=list_participants&session='+encodeURIComponent(sessionId)); let rows = r.data || r; if(Array.isArray(rows)&&rows.length&&Array.isArray(rows[0])){ const h=rows[0]; rows=rows.slice(1).map(a=>{ const o={}; h.forEach((k,i)=>o[k]=a[i]); return o; }); } const list = rows.map(x=>({ id:x['Participant ID']||x.id||cleanIC(x['IC']||x.ic), name:x['Name']||x.name, ic:cleanIC(x['IC']||x.ic), company:x['Company']||x.company||'', ccode:x['Company Code']||x.ccode||'', pos:x['Position']||x.position||'', email:x['Email']||x.email||'', phone:x['Phone']||x.phone||'', session:x['Session ID']||x.session, attend:x['Attendance']||x.attendance||'', mark:x['Mark']||x.mark||'' })); participantsCache.set(sessionId,list); return list; }

/***** DASHBOARD *****/
async function computeDashboard(){ let invited=0, pass=0, fail=0; for(const c of classes){ const parts = await loadParticipants(c.id).catch(()=>[]); invited+=parts.length; for(const p of parts){ if(p.mark!==''&&p.mark!=null){ if(+p.mark>=70) pass++; else fail++; } } } $('#k_prog').textContent=programs.length; $('#k_sess').textContent=classes.length; $('#k_inv').textContent=invited; $('#k_pass').textContent=pass; $('#k_fail').textContent=fail; renderAttendByRole(); renderUpcoming(); renderArchivedInReports(); }
function applyFilter(){ alert('Filter UI only (live data from Sheets).'); }
async function renderAttendByRole(){ const by={}; for(const c of classes){ const list = await loadParticipants(c.id).catch(()=>[]); for(const p of list){ by[p.pos]=by[p.pos]||{inv:0,present:0}; by[p.pos].inv++; if((p.attend||'').toLowerCase()==='present') by[p.pos].present++; } } const rows = Object.entries(by).map(([role,x])=>{ const rate=x.inv?Math.round(100*x.present/x.inv):0; const badge=rate>=85?'ok':rate>=70?'warn':'bad'; return `<tr><td>${role||'-'}</td><td>${x.inv}</td><td>${x.present}</td><td><span class="pill ${badge}">${rate}%</span></td></tr>`; }); $('#tblAttendByRole').innerHTML = tbl(['Role','Invited','Present','Rate'], rows); }
function renderUpcoming(){ const rows = classes.filter(c=>c.active).map(c=>{ const pr = programs.find(p=> (p['Code']||p.Code)===c.prog ); const title = pr? (pr['Title'] + (pr['Sub Title']? ' â€¢ '+pr['Sub Title'] : '')) : c.prog; return `<tr><td>${c.start}</td><td>${c.code}</td><td>${title}</td><td>${c.t1}${c.t2?' + '+c.t2:''}</td></tr>`; }); $('#tblUpcoming').innerHTML = tbl(['Date','Session Code','Program/Module','Trainers'], rows); }

/***** PROGRAMS *****/
function renderPrograms(){ const q = ($('#p_search').value||'').toLowerCase(); const rows = programs.filter(p=> ((p['Title']||'')+(p['Sub Title']||'')+(p['Code']||'')).toLowerCase().includes(q)).map(p=> `<tr><td>${idFmt(p['Program ID']||'-')}</td><td><strong>${p['Title']||''}</strong>${p['Sub Title']? '<br><span class=muted>'+p['Sub Title']+'</span>':''}</td><td>${p['Code']||''}</td><td>${p['Duration (hrs)']||''} h</td><td>${p['Author']||''}</td><td>${p['Registered']? String(p['Registered']).slice(0,10):''}</td></tr>` ); $('#tblPrograms').innerHTML = tbl(['ID','Program / Module','Code','Duration','Author','Reg. Date'], rows); $('#c_prog').innerHTML = programs.map(p=>`<option value="${p['Code']}">${p['Code']} â€” ${p['Title']}${p['Sub Title']?' â€¢ '+p['Sub Title']:''}</option>`).join(''); }
async function saveProgram(){ const obj = { action:'save_program', title: $('#p_title').value||'New Program', sub: $('#p_sub').value||'', code: $('#p_code').value||'CODE', duration:+($('#p_dur').value||0), author: $('#p_author').value||'', reg: $('#p_reg').value||todayISO(), desc: $('#p_desc').value||'' }; const r = await apiPost('save_program', obj).catch(e=>({ok:false,error:e.message})); if(!r.ok){ return alert('Save failed: '+(r.error||'unknown')); } await loadPrograms(); renderPrograms(); computeDashboard(); alert('Program saved'); }

/***** CLASSES *****/
function renderClasses(){ const q = ($('#c_search').value||'').toLowerCase(); const actives = classes.filter(c=> c.active && (c.code+c.prog).toLowerCase().includes(q)); const archived = classes.filter(c=> !c.active && (c.code+c.prog).toLowerCase().includes(q)); const rowHtml = c => { const pr = programs.find(p=> (p['Code']||p.Code)===c.prog); const title = pr? ((p['Title']||'') + (p['Sub Title']?' â€¢ '+p['Sub Title']:'')) : c.prog; return `<tr><td>${idFmt(c.id)}</td><td>${c.code}</td><td>${title}</td><td>${c.start} â†’ ${c.end}</td><td>${c.t1}${c.t2?' + '+c.t2:''}</td><td><span class="pill ${c.active?'ok':'bad'}">${c.active?'Active':'Archived'}</span></td></tr>`; }; const activeRows = actives.map(rowHtml); const archivedRows = archived.map(rowHtml); $('#tblClasses').innerHTML = `<h4>Active Sessions</h4>${tbl(['ID','Session Code','Program/Module','Dates','Trainers','Status'], activeRows)}<h4 style="margin-top:16px">Archived Sessions</h4>${tbl(['ID','Session Code','Program/Module','Dates','Trainers','Status'], archivedRows)}`; const optsActive = actives.map(c=>`<option value="${c.id}">${c.code}</option>`).join(''); ['pa_session','q_session','r_session','r_close_session'].forEach(id=>{ const el = document.getElementById(id); if(el) el.innerHTML = optsActive; }); }
async function saveClass(){ const obj = { action:'save_class', code: $('#c_prog').value, sesscode: $('#c_code').value||'NEW-SESSION', start: $('#c_start').value, end: $('#c_end').value, t1: $('#c_t1').value||'', t2: $('#c_t2').value||'' }; const r = await apiPost('save_class', obj).catch(e=>({ok:false,error:e.message})); if(!r.ok){ return alert('Save failed: '+(r.error||'unknown')); } await loadClasses(); renderClasses(); computeDashboard(); alert('Session saved'); }

/***** PARTICIPANTS *****/
function seedPositions(){ $('#pa_pos').innerHTML = POSITIONS.map(p=>`<option>${p}</option>`).join(''); }
function currentSessionId(){ return $('#pa_session').value || (classes.find(c=>c.active)||{}).id; }
async function addParticipant(){ const s = currentSessionId(); if(!s) return alert('Select a session'); const obj = { action:'save_participant', session:s, name:$('#pa_name').value, ic: cleanIC($('#pa_ic').value), company:$('#pa_company').value, ccode:$('#pa_ccode').value, pos:$('#pa_pos').value, email:$('#pa_email').value, phone:$('#pa_phone').value }; const r = await apiPost('save_participant', obj).catch(e=>({ok:false,error:e.message})); if(!r.ok){ return alert('Add failed: '+(r.error||'unknown')); } await loadParticipants(s); renderParticipants(); computeDashboard(); alert('Participant added'); }
async function renderParticipants(){ const s = currentSessionId(); if(!s){ $('#tblParticipants').innerHTML=''; return; } const list = await loadParticipants(s).catch(()=>[]); const rows = list.map(p=> `<tr><td>${idFmt(p.id||'')}</td><td>${p.name}</td><td>${p.ic}</td><td>${p.company}</td><td>${p.ccode}</td><td>${p.pos}</td><td class=muted>${p.email||''}</td><td class=muted>${p.phone||''}</td></tr>`); $('#tblParticipants').innerHTML = tbl(['ID','Name','IC','Company','Code','Position','Email','Phone'], rows); }

/***** QR *****/
function generateQr(){ const s = $('#q_session').value; const sess = classes.find(c=>c.id===s); if(!sess || !sess.active){ alert('Pick an ACTIVE session'); return; } const link = 'participant.html?session='+encodeURIComponent(s); $('#qr_area').innerHTML = `<div>Link:<br><code>${link}</code><br><span class=muted>Use any free QR generator for this link.</span></div>`; }

/***** RESULTS *****/
async function renderResults(){ const s = $('#r_session').value; if(!s){ $('#tblResultList').innerHTML=''; return; } const sess = classes.find(c=>c.id===s); const list = await loadParticipants(s).catch(()=>[]); const rows = list.map(p=> `<tr><td>${p.name}</td><td>${p.ic}</td><td>${p.pos}</td><td><input ${!sess||!sess.active? 'disabled':''} type=number value="${p.mark??''}" min=0 max=100 style="width:90px" oninput="saveMark('${cleanIC(p.ic)}','${s}', this.value)"/></td></tr>`); $('#tblResultList').innerHTML = tbl(['Name','IC','Position','Mark'], rows); }
async function saveMark(ic, session, v){ const r = await apiPost('save_mark', { action:'save_mark', session, ic, mark: v }).catch(e=>({ok:false,error:e.message})); if(!r.ok){ return alert('Save mark failed'); } }
async function closeSession(){ const s = $('#r_close_session').value; if(!s) return; const r = await apiPost('close_class', { action:'close_class', session: s }).catch(e=>({ok:false,error:e.message})); if(!r.ok){ return alert('Close failed: '+(r.error||'unknown')); } await loadClasses(); renderClasses(); renderResults(); computeDashboard(); alert('Session archived'); }

/***** REPORTS *****/
function renderArchivedInReports(){ const card = document.getElementById('archivedCard'); const archived = classes.filter(c=>!c.active); const rows = archived.map(c=>{ const pr = programs.find(p=> (p['Code']||p.Code)===c.prog); const title = pr? ((p['Title']||'') + (p['Sub Title']?' â€¢ '+p['Sub Title']:'')) : c.prog; const count = (participantsCache.get(c.id)||[]).length; return `<tr><td>${c.code}</td><td>${title}</td><td>${c.start} â†’ ${c.end}</td><td>${c.t1}${c.t2?' + '+c.t2:''}</td><td>${count}</td></tr>`; }); card.innerHTML = `<h3>Archived Sessions (readâ€‘only)</h3><div class="scroller"><table>${tbl(['Session Code','Program/Module','Dates','Trainers','Participants'], rows)}</table></div>`; }

/***** TABS *****/
$$('.tab').forEach(btn=>btn.addEventListener('click',async ()=>{ $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const t = btn.dataset.tab; $$('section[data-panel]').forEach(p=>p.hidden = (p.dataset.panel!==t)); if(t==='participants'){ await renderParticipants(); } if(t==='qr'){ /* nothing */ } if(t==='results'){ await renderResults(); } }));

/***** INIT *****/
function seedPositions(){ $('#pa_pos').innerHTML = POSITIONS.map(p=>`<option>${p}</option>`).join(''); }
async function initAfterLogin(){ seedPositions(); await loadPrograms(); await loadClasses(); renderPrograms(); renderClasses(); await computeDashboard(); }
</script>
</body>
</html>
